---
# Manage secrets for different environments
# Replaces: make generate-secrets, make apply-secrets
- name: Manage Kubernetes Secrets
  hosts: localhost
  connection: local
  gather_facts: true
  
  vars:
    project_dir: "{{ playbook_dir | dirname }}"
    target_env: "{{ env | default('production') }}"  # production, staging, development
    namespace: "{{ target_namespace | default('api-deployment-demo') }}"
    apply_to_cluster: "{{ apply | default(false) }}"
    
  tasks:
    - name: Display secrets management information
      debug:
        msg:
          - "ðŸ” Managing secrets..."
          - "Environment: {{ target_env }}"
          - "Namespace: {{ namespace }}"
          - "Apply to cluster: {{ apply_to_cluster }}"
      
    - name: Check if .env file exists
      stat:
        path: "{{ project_dir }}/.env"
      register: env_file
      
    - name: Fail if .env file not found
      fail:
        msg: "âŒ .env file not found. Copy .env.example to .env: cp .env.example .env"
      when: not env_file.stat.exists
      
    - name: Generate secrets using script
      shell: "{{ project_dir }}/scripts/generate-secrets.sh {{ target_env }} {{ namespace }}"
      args:
        chdir: "{{ project_dir }}"
      environment:
        APPLY: "{{ 'true' if apply_to_cluster else 'false' }}"
      register: secret_generation
      
    - name: Display generation results
      debug:
        msg: "{{ secret_generation.stdout_lines }}"
      
    - name: Check generated secret files
      find:
        paths: "{{ project_dir }}/kubernetes"
        patterns: "secrets-{{ target_env }}.yaml"
      register: secret_files
      
    - name: Display secret file location
      debug:
        msg:
          - "âœ… Secrets generated successfully"
          - "File: {{ secret_files.files[0].path if secret_files.matched > 0 else 'Not found' }}"
      when: not apply_to_cluster
      
    - name: Verify secrets applied to cluster
      kubernetes.core.k8s_info:
        kind: Secret
        namespace: "{{ namespace }}"
        label_selectors:
          - app=api-demo
      register: cluster_secrets
      when: apply_to_cluster
      
    - name: Display applied secrets
      debug:
        msg:
          - "âœ… Secrets applied to cluster"
          - "Namespace: {{ namespace }}"
          - "Secrets found: {{ cluster_secrets.resources | length }}"
      when: apply_to_cluster

---
# Generate TLS secrets
- name: Generate TLS Secrets
  hosts: localhost
  connection: local
  gather_facts: true
  
  vars:
    project_dir: "{{ playbook_dir | dirname }}"
    namespace: "{{ target_namespace | default('api-deployment-demo') }}"
    secret_name: "{{ tls_secret_name | default('nginx-ssl-certs') }}"
    apply_to_cluster: "{{ apply | default(false) }}"
    cert_path: "{{ project_dir }}/nginx/ssl/nginx-selfsigned.crt"
    key_path: "{{ project_dir }}/nginx/ssl/nginx-selfsigned.key"
    
  tasks:
    - name: Display TLS secrets information
      debug:
        msg:
          - "ðŸ” Generating TLS secrets..."
          - "Namespace: {{ namespace }}"
          - "Secret name: {{ secret_name }}"
      
    - name: Check if SSL certificates exist
      stat:
        path: "{{ item }}"
      register: ssl_files
      loop:
        - "{{ cert_path }}"
        - "{{ key_path }}"
      
    - name: Generate self-signed certificates if not exist
      shell: "{{ project_dir }}/nginx/generate-ssl.sh"
      args:
        chdir: "{{ project_dir }}/nginx"
      when: ssl_files.results | selectattr('stat.exists', 'equalto', false) | list | length > 0
      
    - name: Generate TLS secret using script
      shell: "{{ project_dir }}/scripts/generate-tls-secrets.sh {{ namespace }} {{ secret_name }}"
      args:
        chdir: "{{ project_dir }}"
      environment:
        APPLY: "{{ 'true' if apply_to_cluster else 'false' }}"
      register: tls_generation
      
    - name: Display generation results
      debug:
        msg: "{{ tls_generation.stdout_lines }}"
      
    - name: Check generated TLS secret file
      find:
        paths: "{{ project_dir }}/kubernetes"
        patterns: "tls-secret.yaml"
      register: tls_secret_file
      
    - name: Display TLS secret file location
      debug:
        msg:
          - "âœ… TLS secrets generated successfully"
          - "File: {{ tls_secret_file.files[0].path if tls_secret_file.matched > 0 else 'Not found' }}"
      when: not apply_to_cluster
      
    - name: Verify TLS secrets applied to cluster
      kubernetes.core.k8s_info:
        kind: Secret
        name: "{{ secret_name }}"
        namespace: "{{ namespace }}"
      register: cluster_tls_secret
      when: apply_to_cluster
      
    - name: Display applied TLS secret
      debug:
        msg:
          - "âœ… TLS secrets applied to cluster"
          - "Namespace: {{ namespace }}"
          - "Secret name: {{ secret_name }}"
          - "Status: {{ 'Found' if cluster_tls_secret.resources | length > 0 else 'Not found' }}"
      when: apply_to_cluster
