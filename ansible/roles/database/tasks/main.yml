---
# Database role - PostgreSQL installation, configuration, and security
- name: Install PostgreSQL and dependencies
  package:
    name:
      - postgresql
      - postgresql-contrib
      - postgresql-client
      - python3-psycopg2
      - acl
    state: present
    update_cache: yes
  notify: restart postgresql

- name: Check if PostgreSQL is initialized
  stat:
    path: "{{ postgres_data_dir }}/PG_VERSION"
  register: postgres_initialized

- name: Initialize PostgreSQL database
  command: >
    {{ postgres_bin_dir }}/initdb -D {{ postgres_data_dir }}
    --auth-host=md5 --auth-local=peer --encoding=UTF8
    --locale={{ postgres_locale }} --data-checksums
  become_user: postgres
  when: not postgres_initialized.stat.exists
  notify: restart postgresql

- name: Ensure PostgreSQL data directory has secure permissions
  file:
    path: "{{ postgres_data_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'
    recurse: yes

- name: Configure PostgreSQL main configuration
  template:
    src: postgresql.conf.j2
    dest: "{{ postgres_config_dir }}/postgresql.conf"
    owner: postgres
    group: postgres
    mode: '0644'
    backup: yes
  notify: restart postgresql

- name: Configure PostgreSQL host-based authentication
  template:
    src: pg_hba.conf.j2
    dest: "{{ postgres_config_dir }}/pg_hba.conf"
    owner: postgres
    group: postgres
    mode: '0640'
    backup: yes
  notify: reload postgresql

- name: Start and enable PostgreSQL service
  systemd:
    name: postgresql
    state: started
    enabled: yes
    daemon_reload: yes

- name: Create application database
  community.postgresql.postgresql_db:
    name: "{{ vault_db_name }}"
    encoding: UTF-8
    lc_collate: "{{ postgres_locale }}"
    lc_ctype: "{{ postgres_locale }}"
    template: template0
    state: present
  become_user: postgres

- name: Create application database user
  community.postgresql.postgresql_user:
    name: "{{ vault_db_user }}"
    password: "{{ vault_db_password }}"
    db: "{{ vault_db_name }}"
    priv: "ALL"
    role_attr_flags: CREATEDB,NOSUPERUSER
    state: present
  become_user: postgres

- name: Grant additional privileges to database user
  community.postgresql.postgresql_privs:
    database: "{{ vault_db_name }}"
    state: present
    privs: ALL
    type: schema
    obj: public
    roles: "{{ vault_db_user }}"
  become_user: postgres

- name: Create database backup directory
  file:
    path: "{{ db_backup_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0750'
  when: backup_enabled | default(false)

- name: Setup database backup script
  template:
    src: backup-database.sh.j2
    dest: /usr/local/bin/backup-database.sh
    mode: '0750'
    owner: postgres
    group: postgres
  when: backup_enabled | default(false)

- name: Schedule database backups
  cron:
    name: "PostgreSQL database backup"
    cron_file: postgres-backup
    minute: "{{ backup_minute | default('0') }}"
    hour: "{{ backup_hour | default('2') }}"
    day: "*"
    month: "*" 
    weekday: "*"
    user: postgres
    job: "/usr/local/bin/backup-database.sh"
  when: backup_enabled | default(false)

- name: Setup log rotation for PostgreSQL
  template:
    src: postgresql-logrotate.j2
    dest: /etc/logrotate.d/postgresql
    mode: '0644'

- name: Configure PostgreSQL logging
  lineinfile:
    path: "{{ postgres_config_dir }}/postgresql.conf"
    regexp: "^#?{{ item.key }}"
    line: "{{ item.key }} = {{ item.value }}"
    backup: yes
  loop:
    - { key: 'log_destination', value: "'syslog'" }
    - { key: 'log_connections', value: 'on' }
    - { key: 'log_disconnections', value: 'on' }
    - { key: 'log_lock_waits', value: 'on' }
    - { key: 'log_statement', value: "'mod'" }
    - { key: 'log_min_duration_statement', value: '1000' }
  notify: reload postgresql

- name: Ensure PostgreSQL is listening on configured addresses
  lineinfile:
    path: "{{ postgres_config_dir }}/postgresql.conf"
    regexp: "^#?listen_addresses"
    line: "listen_addresses = '{{ postgres_listen_addresses | join(',') }}'"
    backup: yes
  notify: restart postgresql

- name: Set PostgreSQL port
  lineinfile:
    path: "{{ postgres_config_dir }}/postgresql.conf" 
    regexp: "^#?port"
    line: "port = {{ postgres_port }}"
    backup: yes
  notify: restart postgresql

- name: Configure PostgreSQL memory settings
  lineinfile:
    path: "{{ postgres_config_dir }}/postgresql.conf"
    regexp: "^#?{{ item.key }}"
    line: "{{ item.key }} = {{ item.value }}"
    backup: yes
  loop:
    - { key: 'shared_buffers', value: '{{ postgres_shared_buffers }}' }
    - { key: 'effective_cache_size', value: '{{ postgres_effective_cache_size }}' }
    - { key: 'work_mem', value: '{{ postgres_work_mem }}' }
    - { key: 'maintenance_work_mem', value: '{{ postgres_maintenance_work_mem }}' }
  notify: restart postgresql

- name: Configure connection limits
  lineinfile:
    path: "{{ postgres_config_dir }}/postgresql.conf"
    regexp: "^#?max_connections"
    line: "max_connections = {{ postgres_max_connections }}"
    backup: yes
  notify: restart postgresql

- name: Verify PostgreSQL is running and accepting connections
  community.postgresql.postgresql_ping:
    db: "{{ vault_db_name }}"
    login_user: "{{ vault_db_user }}"
    login_password: "{{ vault_db_password }}"
    login_host: localhost
    login_port: "{{ postgres_port }}"
  retries: 5
  delay: 10