#!/bin/bash

# API Health Monitor Script
API_URL="http://localhost:{{ api_port }}/health"
NGINX_URL="http://localhost/health"
ALERT_EMAIL="{{ alert_email | default('ops@company.com') }}"
LOG_FILE="/var/log/health-monitor.log"

check_service() {
    local url=$1
    local service_name=$2
    
    if curl -f -s --max-time 10 "$url" >/dev/null 2>&1; then
        echo "$(date): $service_name OK" >> "$LOG_FILE"
        return 0
    else
        echo "$(date): $service_name FAILED" >> "$LOG_FILE"
        return 1
    fi
}

# Check API health
if ! check_service "$API_URL" "API"; then
    echo "API health check failed - attempting restart" >> "$LOG_FILE"
    systemctl restart api-app
    
    # Send alert (if mail is configured)
    if command -v mail >/dev/null 2>&1; then
        echo "API service health check failed and service was restarted" | \
            mail -s "API Service Alert - {{ ansible_hostname }}" "$ALERT_EMAIL"
    fi
fi

# Check Nginx health  
if ! check_service "$NGINX_URL" "Nginx"; then
    echo "Nginx health check failed - attempting restart" >> "$LOG_FILE"
    systemctl restart nginx
    
    if command -v mail >/dev/null 2>&1; then
        echo "Nginx service health check failed and service was restarted" | \
            mail -s "Nginx Service Alert - {{ ansible_hostname }}" "$ALERT_EMAIL"
    fi
fi

# Check Docker containers
FAILED_CONTAINERS=$(docker ps -a --filter "status=exited" --format "{{.Names}}" | grep "{{ app_name }}")
if [ -n "$FAILED_CONTAINERS" ]; then
    echo "$(date): Failed containers detected: $FAILED_CONTAINERS" >> "$LOG_FILE"
    
    if command -v mail >/dev/null 2>&1; then
        echo "Failed Docker containers detected: $FAILED_CONTAINERS" | \
            mail -s "Docker Container Alert - {{ ansible_hostname }}" "$ALERT_EMAIL"
    fi
fi