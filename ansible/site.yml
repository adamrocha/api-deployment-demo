---
# Main Ansible Playbook for API Deployment Demo
- name: Deploy API Application Stack
  hosts: "{{ target_env | default('staging') }}"
  become: true
  gather_facts: true
  
  vars:
    app_name: api-deployment-demo
    app_version: "{{ version | default('latest') }}"
    deploy_user: "{{ ansible_user }}"
    app_dir: "/opt/{{ app_name }}"
    
  pre_tasks:
    - name: Update system packages
      package:
        update_cache: yes
      tags: [system, never]
    
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'
      tags: [setup]

  roles:
    - role: docker
      tags: [docker, infrastructure]
    - role: ssl-certificates  
      tags: [ssl, security]
      when: ssl_enabled | default(false) | bool
    - role: api-app
      tags: [application, api]
    - role: monitoring
      tags: [monitoring, observability]
      when: monitoring_enabled | default(true) | bool

  post_tasks:
    - name: Verify application health
      uri:
        url: "http://{{ ansible_host }}:{{ api_port | default(8000) }}/health"
        method: GET
        timeout: 30
      register: health_check
      retries: 5
      delay: 10
      tags: [verification]

    - name: Display deployment status
      debug:
        msg: |
          Deployment completed successfully!
          Application URL: http://{{ ansible_host }}{% if http_port != 80 %}:{{ http_port }}{% endif %}
          API Health: {{ health_check.json.status | default('Unknown') }}
      tags: [verification]

  handlers:
    - name: restart docker
      service:
        name: docker
        state: restarted
        
    - name: restart nginx
      service:
        name: nginx
        state: restarted