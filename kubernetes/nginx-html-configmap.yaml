apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-html
  namespace: api-deployment-demo
  labels:
    app: api-demo
    component: nginx
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>API Deployment Demo - Interactive Dashboard</title>
        <style>
            * { 
                margin: 0; 
                padding: 0; 
                box-sizing: border-box; 
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #333;
                min-height: 100vh;
                line-height: 1.6;
            }
            
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            
            header {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 30px;
                margin-bottom: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            
            .logo {
                font-size: 2.5em;
                font-weight: bold;
                background: linear-gradient(45deg, #667eea, #764ba2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 10px;
            }
            
            .environment-badge {
                display: inline-block;
                padding: 8px 16px;
                border-radius: 25px;
                font-weight: bold;
                font-size: 0.9em;
                margin-top: 10px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            
            .env-kubernetes { background: #4CAF50; color: white; }
            .env-docker { background: #2196F3; color: white; }
            .env-local { background: #FF9800; color: white; }
            .env-production { background: #F44336; color: white; }
            
            .main-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-bottom: 30px;
            }
            
            .card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 25px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
            }
            
            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }
            
            .card h2 {
                color: #667eea;
                margin-bottom: 20px;
                font-size: 1.5em;
                border-bottom: 3px solid #667eea;
                padding-bottom: 10px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #555;
            }
            
            input, textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 16px;
                transition: all 0.3s ease;
            }
            
            input:focus, textarea:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            
            .btn {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-right: 10px;
                margin-bottom: 10px;
            }
            
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }
            
            .btn:active {
                transform: translateY(0);
            }
            
            .btn-secondary {
                background: linear-gradient(45deg, #6c757d, #495057);
            }
            
            .btn-danger {
                background: linear-gradient(45deg, #dc3545, #c82333);
            }
            
            .status {
                padding: 15px;
                border-radius: 10px;
                margin-top: 20px;
                font-weight: 600;
            }
            
            .status.success {
                background: #d4edda;
                border: 1px solid #c3e6cb;
                color: #155724;
            }
            
            .status.error {
                background: #f8d7da;
                border: 1px solid #f5c6cb;
                color: #721c24;
            }
            
            .status.info {
                background: #cce7ff;
                border: 1px solid #99d3ff;
                color: #004085;
            }
            
            .users-list {
                max-height: 300px;
                overflow-y: auto;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                padding: 15px;
                background: #f8f9fa;
            }
            
            .user-item {
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                transition: all 0.3s ease;
            }
            
            .user-item:hover {
                border-color: #667eea;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            }
            
            .user-item:last-child {
                margin-bottom: 0;
            }
            
            .user-name {
                font-weight: 600;
                color: #667eea;
                font-size: 1.1em;
            }
            
            .user-email {
                color: #6c757d;
                margin: 5px 0;
            }
            
            .user-date {
                font-size: 0.9em;
                color: #adb5bd;
            }
            
            .deployment-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 30px;
            }
            
            .deployment-card {
                background: rgba(255, 255, 255, 0.95);
                border-radius: 15px;
                padding: 20px;
                text-align: center;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
            }
            
            .deployment-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }
            
            .deployment-title {
                font-size: 1.3em;
                font-weight: bold;
                margin-bottom: 10px;
                color: #667eea;
            }
            
            .deployment-status {
                padding: 8px 16px;
                border-radius: 20px;
                font-weight: 600;
                margin: 10px 0;
            }
            
            .status-healthy {
                background: #d4edda;
                color: #155724;
            }
            
            .status-unhealthy {
                background: #f8d7da;
                color: #721c24;
            }
            
            .hidden {
                display: none;
            }
            
            @media (max-width: 768px) {
                .main-content {
                    grid-template-columns: 1fr;
                }
                
                .container {
                    padding: 15px;
                }
                
                .logo {
                    font-size: 2em;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <div class="logo">üöÄ API Deployment Demo</div>
                <p style="font-size: 1.2em; color: #666; margin-bottom: 15px;">Interactive Kubernetes Dashboard</p>
                <div id="environment-info" class="environment-badge">Detecting Environment...</div>
            </header>
            
            <div class="main-content">
                <div class="card">
                    <h2>üåç Hello World! Workflow</h2>
                    <form id="user-form">
                        <div class="form-group">
                            <label for="userName">Name:</label>
                            <input type="text" id="userName" name="name" placeholder="Enter your name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="userEmail">Email:</label>
                            <input type="email" id="userEmail" name="email" placeholder="Enter your email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="userMessage">Message:</label>
                            <textarea id="userMessage" name="message" placeholder="Enter your Hello World message" rows="3"></textarea>
                        </div>
                        
                        <button type="submit" class="btn">Add User</button>
                        <button type="button" class="btn btn-secondary" onclick="loadUsers()">Refresh List</button>
                    </form>
                    
                    <div id="form-status"></div>
                </div>
                
                <div class="card">
                    <h2>üë• Users Directory</h2>
                    <button class="btn btn-secondary" onclick="loadUsers()" style="margin-bottom: 15px;">Load Users</button>
                    <div id="users-container" class="users-list">
                        <div class="status info">Click "Load Users" to see the directory</div>
                    </div>
                </div>
            </div>
            
            <div class="deployment-grid">
                <div class="deployment-card">
                    <div class="deployment-title">üîÑ Task 1: Docker Compose</div>
                    <div class="deployment-status status-healthy">Staging Environment</div>
                    <p>Local development with Docker containers</p>
                </div>
                
                <div class="deployment-card">
                    <div class="deployment-title">üîß Task 2: Ansible Automation</div>
                    <div class="deployment-status status-healthy">Configuration Management</div>
                    <p>Automated deployment with security monitoring</p>
                </div>
                
                <div class="deployment-card">
                    <div class="deployment-title">‚ò∏Ô∏è Task 3: Kubernetes Production</div>
                    <div class="deployment-status status-healthy">Production Ready</div>
                    <p>StatefulSets, HPA, and advanced networking</p>
                </div>
            </div>
        </div>
        
        <script>
            let API_BASE_URL = '';
            let currentEnvironment = 'unknown';
            
            // Environment detection and API URL configuration
            async function detectEnvironment() {
                const envBadge = document.getElementById('environment-info');
                
                try {
                    // Try different possible API endpoints
                    const endpoints = [
                        '/health', // Kubernetes environment (through ingress/nginx proxy)
                        '/api/health', // API through nginx proxy with /api prefix
                        'http://localhost:8000/health', // Direct API access (if CORS allows)
                    ];
                    
                    for (const endpoint of endpoints) {
                        try {
                            const response = await fetch(endpoint, { 
                                method: 'GET',
                                timeout: 3000 
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                currentEnvironment = data.environment || 'unknown';
                                const deployment = data.deployment || 'unknown';
                                
                            // Set API base URL based on successful endpoint
                            if (endpoint === '/health') {
                                API_BASE_URL = ''; // Same origin, API calls direct
                            } else if (endpoint === '/api/health') {
                                API_BASE_URL = '/api'; // Through nginx /api proxy
                            } else {
                                API_BASE_URL = endpoint.replace('/health', ''); // Direct API server
                            }
                                // Update environment display
                                let className = 'env-kubernetes';
                                let displayText = `${currentEnvironment.toUpperCase()} (${deployment})`;
                                
                                if (currentEnvironment === 'staging') className = 'env-docker';
                                else if (currentEnvironment === 'local') className = 'env-local';
                                else if (currentEnvironment === 'production') className = 'env-production';
                                
                                envBadge.textContent = displayText;
                                envBadge.className = `environment-badge ${className}`;
                                
                                console.log(`Environment detected: ${currentEnvironment} via ${endpoint}`);
                                return;
                            }
                        } catch (error) {
                            console.log(`Failed to connect to ${endpoint}:`, error.message);
                            continue;
                        }
                    }
                    
                    // If all endpoints fail
                    envBadge.textContent = 'API Unavailable';
                    envBadge.className = 'environment-badge env-local';
                    
                } catch (error) {
                    console.error('Environment detection failed:', error);
                    envBadge.textContent = 'Detection Failed';
                    envBadge.className = 'environment-badge env-local';
                }
            }
            
            // API interaction functions
            async function apiCall(endpoint, options = {}) {
                try {
                    const url = API_BASE_URL + endpoint;
                    const response = await fetch(url, {
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`API call failed for ${endpoint}:`, error);
                    throw error;
                }
            }
            
            // Load and display users
            async function loadUsers() {
                const container = document.getElementById('users-container');
                container.innerHTML = '<div class="status info">Loading users...</div>';
                
                try {
                    const users = await apiCall('/users');
                    
                    if (users.length === 0) {
                        container.innerHTML = '<div class="status info">No users yet. Add the first one!</div>';
                        return;
                    }
                    
                    container.innerHTML = users.map(user => `
                        <div class="user-item">
                            <div class="user-name">${escapeHtml(user.name)}</div>
                            <div class="user-email">${escapeHtml(user.email)}</div>
                            <div class="user-date">Created: ${new Date(user.created_at).toLocaleString()}</div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    container.innerHTML = `<div class="status error">Failed to load users: ${error.message}</div>`;
                }
            }
            
            // Add new user
            async function addUser(userData) {
                try {
                    const newUser = await apiCall('/users', {
                        method: 'POST',
                        body: JSON.stringify(userData)
                    });
                    
                    showStatus('success', `User "${newUser.name}" added successfully!`);
                    document.getElementById('user-form').reset();
                    await loadUsers(); // Refresh the list
                    
                } catch (error) {
                    showStatus('error', `Failed to add user: ${error.message}`);
                }
            }
            
            // Utility functions
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function showStatus(type, message) {
                const statusDiv = document.getElementById('form-status');
                statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
                
                // Auto-hide success messages
                if (type === 'success') {
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                }
            }
            
            // Form submission handler
            document.getElementById('user-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const userData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    message: formData.get('message') || 'Hello World!'
                };
                
                if (!userData.name || !userData.email) {
                    showStatus('error', 'Please fill in all required fields.');
                    return;
                }
                
                await addUser(userData);
            });
            
            // Initialize the application
            document.addEventListener('DOMContentLoaded', function() {
                detectEnvironment();
            });
        </script>
    </body>
    </html>